<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Manager API Tester</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .test-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .endpoint-card {
            margin: 10px 0;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .method-badge {
            font-size: 0.75em;
            padding: 0.25em 0.5em;
            border-radius: 3px;
            color: white;
            font-weight: bold;
        }
        .method-get { background-color: #28a745; }
        .method-post { background-color: #007bff; }
        .method-put { background-color: #ffc107; color: #212529; }
        .method-delete { background-color: #dc3545; }
        .json-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-12">
                <h1 class="text-center mb-4">
                    <i class="fas fa-utensils text-primary"></i>
                    Recipe Manager API Tester
                </h1>
                
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle"></i> API Testing Interface</h5>
                    <p>Test all endpoints of the Recipe Manager API with real-time results. Make sure your API server is running on <code>http://localhost:8080</code></p>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-play-circle text-success"></i> Quick Tests</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success btn-sm w-100 mb-2" onclick="testApiStatus()">
                            <i class="fas fa-heartbeat"></i> Test API Status
                        </button>
                        <button class="btn btn-primary btn-sm w-100 mb-2" onclick="testAllEndpoints()">
                            <i class="fas fa-rocket"></i> Test All Endpoints
                        </button>
                        <button class="btn btn-warning btn-sm w-100 mb-2" onclick="clearResults()">
                            <i class="fas fa-trash"></i> Clear Results
                        </button>
                        <button class="btn btn-info btn-sm w-100 mb-2" onclick="loadSampleData()">
                            <i class="fas fa-database"></i> Load Sample Data
                        </button>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h6>API Statistics</h6>
                    </div>
                    <div class="card-body">
                        <div id="api-stats">
                            <div class="text-muted">Run tests to see statistics</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal"></i> Test Results</h5>
                    </div>
                    <div class="card-body" id="test-results">
                        <div class="text-muted text-center py-4">
                            <i class="fas fa-flask fa-2x mb-2"></i>
                            <p>Click "Test All Endpoints" to start testing the API</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:8080';
        let testResults = [];

        function addResult(test, success, data, error = null) {
            testResults.push({ test, success, data, error, timestamp: new Date() });
            
            const resultsDiv = document.getElementById('test-results');
            const resultElement = document.createElement('div');
            resultElement.className = `test-result ${success ? 'test-success' : 'test-error'}`;
            
            resultElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <strong>${success ? '✅' : '❌'} ${test}</strong>
                    <small>${new Date().toLocaleTimeString()}</small>
                </div>
                ${error ? `<div class="mt-2 text-danger">${error}</div>` : ''}
                <div class="json-output mt-2">${JSON.stringify(data, null, 2)}</div>
            `;
            
            resultsDiv.appendChild(resultElement);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            
            updateStats();
        }

        function updateStats() {
            const total = testResults.length;
            const passed = testResults.filter(r => r.success).length;
            const failed = total - passed;
            
            document.getElementById('api-stats').innerHTML = `
                <div class="row text-center">
                    <div class="col-4">
                        <div class="text-primary h4">${total}</div>
                        <small>Total</small>
                    </div>
                    <div class="col-4">
                        <div class="text-success h4">${passed}</div>
                        <small>Passed</small>
                    </div>
                    <div class="col-4">
                        <div class="text-danger h4">${failed}</div>
                        <small>Failed</small>
                    </div>
                </div>
                <div class="mt-2">
                    <div class="progress">
                        <div class="progress-bar bg-success" style="width: ${total > 0 ? (passed/total)*100 : 0}%"></div>
                    </div>
                </div>
            `;
        }

        async function makeRequest(method, endpoint, data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                };

                if (data && ['POST', 'PUT', 'PATCH'].includes(method)) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(API_BASE + endpoint, options);
                const responseData = await response.json();
                
                return {
                    success: response.ok,
                    status: response.status,
                    data: responseData
                };
            } catch (error) {
                return {
                    success: false,
                    status: 0,
                    error: error.message
                };
            }
        }

        async function testApiStatus() {
            clearResults();
            addResult('Testing API Connection...', true, 'Starting test...');
            
            const result = await makeRequest('GET', '/');
            addResult('API Status', result.success, result.data, result.error);
            
            if (result.success) {
                const healthResult = await makeRequest('GET', '/health');
                addResult('Health Check', healthResult.success, healthResult.data, healthResult.error);
            }
        }

        async function testAllEndpoints() {
            clearResults();
            addResult('Starting Comprehensive API Test', true, 'Testing all endpoints...');

            const tests = [
                // Basic API tests
                { method: 'GET', endpoint: '/', name: 'API Root' },
                { method: 'GET', endpoint: '/health', name: 'Health Check' },
                { method: 'GET', endpoint: '/stats', name: 'API Statistics' },
                
                // Entity tests
                { method: 'GET', endpoint: '/users', name: 'Get Users' },
                { method: 'GET', endpoint: '/categories', name: 'Get Categories' },
                { method: 'GET', endpoint: '/ingredients', name: 'Get Ingredients' },
                { method: 'GET', endpoint: '/recipes', name: 'Get Recipes' },
                { method: 'GET', endpoint: '/reviews', name: 'Get Reviews' },
                { method: 'GET', endpoint: '/roles', name: 'Get Roles' },
                
                // Advanced endpoints
                { method: 'GET', endpoint: '/categories/with-count', name: 'Categories with Count' },
                { method: 'GET', endpoint: '/ingredients/most-used', name: 'Most Used Ingredients' },
                { method: 'GET', endpoint: '/recipes/search?q=test', name: 'Recipe Search' },
                { method: 'GET', endpoint: '/recipes/recent', name: 'Recent Recipes' },
                { method: 'GET', endpoint: '/reviews/recent', name: 'Recent Reviews' },
            ];

            for (const test of tests) {
                const result = await makeRequest(test.method, test.endpoint);
                addResult(test.name, result.success, result.data, result.error);
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            addResult('Test Suite Complete', true, `Completed ${tests.length} endpoint tests`);
        }

        async function loadSampleData() {
            addResult('Loading Sample Data...', true, 'Creating sample records...');

            // Sample category
            const categoryData = {
                name: 'Test Category',
                description: 'Sample category for testing'
            };
            const categoryResult = await makeRequest('POST', '/categories', categoryData);
            addResult('Create Sample Category', categoryResult.success, categoryResult.data, categoryResult.error);

            // Sample ingredient
            const ingredientData = {
                name: 'Test Ingredient',
                description: 'Sample ingredient for testing'
            };
            const ingredientResult = await makeRequest('POST', '/ingredients', ingredientData);
            addResult('Create Sample Ingredient', ingredientResult.success, ingredientResult.data, ingredientResult.error);

            // Sample user
            const userData = {
                name: 'Test User',
                email: 'testuser' + Date.now() + '@example.com',
                password: 'password123',
                role_id: 3
            };
            const userResult = await makeRequest('POST', '/users', userData);
            addResult('Create Sample User', userResult.success, userResult.data, userResult.error);
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = `
                <div class="text-muted text-center py-2">
                    <i class="fas fa-broom"></i> Results cleared
                </div>
            `;
            testResults = [];
            updateStats();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
        });
    </script>
</body>
</html>